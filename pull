#!/usr/bin/env node

var params = parseArgv(process.argv)
log(params)
if (!params.hasOwnProperty('timeout')) params.timeout = 3000
if (!params.hasOwnProperty('scale')) params.scale = 'celsius'
pull(params)

/*
 * Functions
 */

function pull(params) {
  var exec = require('child_process').exec;
  log('trying...')
  var cmd = __dirname + '/try --path ' + params.path + ' --scale ' + params.scale
  if (params.verbose) cmd += ' --verbose'
  log(cmd)
  var child = exec(cmd, function(err, stdout, stderr) {
    if (stdout) {
      console.log(stdout)
      process.exit(0)
    }
  })
  setTimeout(function() {
    child.kill('SIGKILL')
    pull(params)
  }, params.timeout)
}

function parseArgv(argv) {
  params = {}
  argv.forEach(function(arg, i) {
    if (arg.substr(0, 2) == '--') {
      paramName = arg.substr(2, arg.length)
      nextArg = argv[i+1]
      if (typeof nextArg == 'string' && nextArg.substr(0, 2) == '--') {
        params[paramName] = true
      }
      else {
        params[paramName] = nextArg
      }
    }
  })
  return params
}

// A log function that will only log if the --verbose flag is set
function log(msg) {
  if (params.hasOwnProperty('verbose')) {
    console.log(msg)
  }
}
