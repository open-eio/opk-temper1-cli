#!/usr/bin/env node

var exec = require('child_process').exec;
var program = require('commander');
var log = function(msg) {
  if (program.verbose) {
    console.log(msg)
  }
}

program
  .version('0.2.0')
  .option('-p, --path <path>', 'Set a path to the temper1 device. Detect the path by running the detect command.', '')
  .option('-t, --timeout [timeout]', 'How long before trying the `try` command again. If you are on a slow system you may need to increase this.', 1000)
  .option('-t, --threshold [threshold]', '', 1)
  .option('-s, --scale [scale]', 'Say farenheit if you dont want celsius.', 'celsius')
  .option('-v, --verbose', 'Turn on verbose mode')
  .parse(process.argv);

var poll = function() {
  log('trying...')
  var cmd = __dirname + '/try --path ' + program.path + ' --scale ' + program.scale
  if (program.verbose) cmd += ' --verbose'
  log(cmd)
  var child = exec(cmd, function(err, stdout, stderr) {
    if (stdout) {
      child.kill('SIGKILL')
      sendOutput(stdout)
    }
  })
  setTimeout(function() {
    child.kill('SIGKILL')
  }, program.timeout-100)
}

setInterval(poll, program.timeout)
poll()

var lastOutput = 9999
var sendOutput = function(output) {
  output = parseFloat(output)
  if (output > (lastOutput + program.threshold) || output < (lastOutput - program.threshold)) {
    lastOutput = output
    process.stdout.write(output + ',')
  }
}
